/* @license
 * Copyright (c) 2017, Jeff Hlywa (jhlywa@gmail.com)
 * Released under the BSD license
 * https://github.com/jhlywa/chess.js/blob/master/LICENSE
 */
var Chess=function(r,e){function n(r){"undefined"==typeof r&&(r=!1),vr=new Array(128),Er={w:j,b:j},hr=$,_r={w:0,b:0},Sr=j,dr=0,Ar=1,br=[],r||(Cr={}),u(f())}function t(){o(V)}function o(r,e,t){"undefined"==typeof e&&(e=!1),t&&(mr=t);var o=r.split(/\s+/),a=o[0],l=0;if(!i(r).valid)return!1;n(e),o[2].indexOf("K")>-1&&(_r.w|=ar.KSIDE_CASTLE),o[2].indexOf("Q")>-1&&(_r.w|=ar.QSIDE_CASTLE),o[2].indexOf("k")>-1&&(_r.b|=ar.KSIDE_CASTLE),o[2].indexOf("q")>-1&&(_r.b|=ar.QSIDE_CASTLE);for(var p=0;p<a.length;p++){var c=a.charAt(p);if("/"===c)l+=8;else if(O(c))l+=parseInt(c,10);else{var v="a">c?$:B;s({type:c.toLowerCase(),color:v},Q(l)),vr[l].type==W&&mr==rr&&(_r[v]&ar.QSIDE_CASTLE&&Er[v]==j&&(gr[v][0]={square:l,flag:ar.QSIDE_CASTLE}),_r[v]&ar.KSIDE_CASTLE&&Er[v]!=j&&(gr[v][1]={square:l,flag:ar.KSIDE_CASTLE})),l++}}if(hr=o[1],gr={w:[],b:[]},o[2].indexOf("K")>-1){_r.w|=ar.KSIDE_CASTLE;for(var g=cr.h1;g>=cr.c1;--g)if(E(vr[g],$)){gr[$].push({square:g,flag:ar.KSIDE_CASTLE});break}}if(o[2].indexOf("Q")>-1){_r.w|=ar.QSIDE_CASTLE;for(var g=cr.a1;g<=cr.g1;++g)if(E(vr[g],$)){gr[$].push({square:g,flag:ar.QSIDE_CASTLE});break}}var p,h,_=o[2].match(/[A-H]/g);if(null!==_)for(p=0;p<_.length;++p){var g=cr.a1+(_[p].charCodeAt(0)-"A".charCodeAt(0));h=g<Er[$]?ar.QSIDE_CASTLE:ar.KSIDE_CASTLE,_r.w|=h,gr[$].push({square:g,flag:h})}if(o[2].indexOf("k")>-1){_r.b|=ar.KSIDE_CASTLE;for(var g=cr.h8;g>=cr.c8;--g)if(E(vr[g],B)){gr[B].push({square:g,flag:ar.KSIDE_CASTLE});break}}if(o[2].indexOf("q")>-1){_r.b|=ar.QSIDE_CASTLE;for(var g=cr.a8;g<=cr.g8;++g)if(E(vr[g],B)){gr[B].push({square:g,flag:ar.QSIDE_CASTLE});break}}var S=o[2].match(/[a-h]/g);if(null!==S)for(p=0;p<S.length;++p){var g=cr.a8+(S[p].charCodeAt(0)-"a".charCodeAt(0));h=g<Er[B]?ar.QSIDE_CASTLE:ar.KSIDE_CASTLE,_r.b|=h,gr[B].push({square:g,flag:h})}return Sr="-"===o[3]?j:cr[o[3]],dr=parseInt(o[4],10),Ar=parseInt(o[5],10),u(f()),!0}function i(r){var e={0:"No errors.",1:"FEN string must contain six space-delimited fields.",2:"6th field (move number) must be a positive integer.",3:"5th field (half move counter) must be a non-negative integer.",4:"4th field (en-passant square) is invalid.",5:"3rd field (castling availability) is invalid.",6:"2nd field (side to move) is invalid.",7:"1st field (piece positions) does not contain 8 '/'-delimited rows.",8:"1st field (piece positions) is invalid [consecutive numbers].",9:"1st field (piece positions) is invalid [invalid piece].",10:"1st field (piece positions) is invalid [row too large].",11:"Illegal en-passant square"},n=r.split(/\s+/);if(6!==n.length)return{valid:!1,error_number:1,error:e[1]};if(isNaN(n[5])||parseInt(n[5],10)<=0)return{valid:!1,error_number:2,error:e[2]};if(isNaN(n[4])||parseInt(n[4],10)<0)return{valid:!1,error_number:3,error:e[3]};if(!/^(-|[abcdefgh][36])$/.test(n[3]))return{valid:!1,error_number:4,error:e[4]};if(!/^[C-HK]?[A-FQ]?[c-hk]?[a-fq]?$/.test(n[2])&&"-"!==n[2])return{valid:!1,error_number:5,error:e[5]};if(!/^(w|b)$/.test(n[1]))return{valid:!1,error_number:6,error:e[6]};var t=n[0].split("/");if(8!==t.length)return{valid:!1,error_number:7,error:e[7]};for(var o=0;o<t.length;o++){for(var i=0,f=!1,a=0;a<t[o].length;a++)if(isNaN(t[o][a])){if(!/^[prnbqkPRNBQK]$/.test(t[o][a]))return{valid:!1,error_number:9,error:e[9]};i+=1,f=!1}else{if(f)return{valid:!1,error_number:8,error:e[8]};i+=parseInt(t[o][a],10),f=!0}if(8!==i)return{valid:!1,error_number:10,error:e[10]}}return"3"==n[3][1]&&"w"==n[1]||"6"==n[3][1]&&"b"==n[1]?{valid:!1,error_number:11,error:e[11]}:{valid:!0,error_number:0,error:e[0]}}function f(){for(var r=0,e="",n=cr.a8;n<=cr.h1;n++){if(null==vr[n])r++;else{r>0&&(e+=r,r=0);var t=vr[n].color,o=vr[n].type;e+=t===$?o.toUpperCase():o.toLowerCase()}n+1&136&&(r>0&&(e+=r),n!==cr.h1&&(e+="/"),r=0,n+=8)}var i,f="";_r[$]&ar.KSIDE_CASTLE&&(i=g(vr,$,ar.KSIDE_CASTLE),f+=h(vr,$,ar.KSIDE_CASTLE,i)?"K":"ABCDEFGH".substring(q(i),q(i)+1)),_r[$]&ar.QSIDE_CASTLE&&(i=g(vr,$,ar.QSIDE_CASTLE),f+=h(vr,$,ar.QSIDE_CASTLE,i)?"Q":"ABCDEFGH".substring(q(i),q(i)+1)),_r[B]&ar.KSIDE_CASTLE&&(i=g(vr,B,ar.KSIDE_CASTLE),f+=h(vr,B,ar.KSIDE_CASTLE,i)?"k":"abcdefgh".substring(q(i),q(i)+1)),_r[B]&ar.QSIDE_CASTLE&&(i=g(vr,B,ar.QSIDE_CASTLE),f+=h(vr,B,ar.QSIDE_CASTLE,i)?"q":"abcdefgh".substring(q(i),q(i)+1)),f=f||"-";var a=Sr===j?"-":Q(Sr);return[e,hr,f,a,dr,Ar].join(" ")}function a(r){for(var e=0;e<r.length;e+=2)"string"==typeof r[e]&&"string"==typeof r[e+1]&&(Cr[r[e]]=r[e+1]);return Cr}function u(r){br.length>0||(r!==V?(Cr.SetUp="1",Cr.FEN=r):(delete Cr.SetUp,delete Cr.FEN))}function l(r){var e=vr[cr[r]];return e?{type:e.type,color:e.color}:null}function s(r,e){if(!("type"in r&&"color"in r))return!1;if(-1===J.indexOf(r.type.toLowerCase()))return!1;if(!(e in cr))return!1;var n=cr[e];return r.type==z&&Er[r.color]!=j&&Er[r.color]!=n?!1:(vr[n]={type:r.type,color:r.color},r.type===z&&(Er[r.color]=n),u(f()),!0)}function p(r){var e=l(r);return vr[cr[r]]=null,e&&e.type===z&&(Er[e.color]=j),u(f()),e}function c(r,e,n,t,o,i){var f={color:hr,from:e,to:n,flags:t,piece:r[e].type};return o&&(f.flags|=ar.PROMOTION,f.promotion=o),t&(ar.KSIDE_CASTLE|ar.QSIDE_CASTLE)?f.rook_sq=i:r[n]?f.captured=r[n].type:t&ar.EP_CAPTURE&&(f.captured=F),f}function v(r){function e(r,e,n,t,o,i){if(r[n].type!==F||K(t)!==pr&&K(t)!==ur)e.push(c(r,n,t,o,void 0,i));else for(var f=[Z,W,H,G],a=0,u=f.length;u>a;a++)e.push(c(r,n,t,o,f[a]))}function n(r,e,n,t,o,i){var f,a=Math.min(e,n),u=Math.max(e,n),l=Math.min(a,Math.min(t,o)),s=Math.max(u,Math.max(t,o));for(f=l;s>=f;++f)if(f!=e&&f!=t&&r[f])return!1;for(f=a;u>=f;++f)if(d(i,f))return!1;return!0}var t=[],o=hr,i=R(o),f={b:sr,w:lr},a=cr.a8,u=cr.h1,l=!1,s="undefined"!=typeof r&&"legal"in r?r.legal:!0;if("undefined"!=typeof r&&"square"in r){if(!(r.square in cr))return[];a=u=cr[r.square],l=!0}for(var p=a;u>=p;p++)if(136&p)p+=7;else{var v=vr[p];if(null!=v&&v.color===o)if(v.type===F){var E=p+er[o][0];if(null==vr[E]){e(vr,t,p,E,ar.NORMAL);var E=p+er[o][1];f[o]===K(p)&&null==vr[E]&&e(vr,t,p,E,ar.BIG_PAWN)}for(h=2;4>h;h++){var E=p+er[o][h];136&E||(null!=vr[E]&&vr[E].color===i?e(vr,t,p,E,ar.CAPTURE):E===Sr&&e(vr,t,p,Sr,ar.EP_CAPTURE))}}else for(var h=0,_=nr[v.type].length;_>h;h++)for(var S=nr[v.type][h],E=p;;){if(E+=S,136&E)break;if(null!=vr[E]){if(vr[E].color===o)break;e(vr,t,p,E,ar.CAPTURE);break}if(e(vr,t,p,E,ar.NORMAL),"n"===v.type||"k"===v.type)break}}if(!l||u===Er[o]){if(_r[o]&ar.KSIDE_CASTLE){var b=Er[o],C=o===$?cr.g1:cr.g8,m=g(vr,o,ar.KSIDE_CASTLE),T=C-1;n(vr,b,C,m,T,i)&&e(vr,t,b,C,ar.KSIDE_CASTLE,m)}if(_r[o]&ar.QSIDE_CASTLE){var b=Er[o],C=o===$?cr.c1:cr.c8,m=g(vr,o,ar.QSIDE_CASTLE),T=C+1;n(vr,b,C,m,T,i)&&e(vr,t,b,C,ar.QSIDE_CASTLE,m)}}if(!s)return t;for(var y=[],p=0,_=t.length;_>p;p++)L(t[p]),A(o)||y.push(t[p]),D();return y}function E(r,e){return"undefined"!=typeof r&&null!==r&&r.type===W&&r.color==e}function g(r,e,n){for(var t=0,o=gr[e].length;o>t;t++)if(n&gr[e][t].flag)return gr[e][t].square;return null}function h(r,e,n,t){var o;if(n==ar.KSIDE_CASTLE){for(var o=e==$?cr.h1:cr.h8;++t<=o;)if(E(r[t],e))return!1}else for(var o=e==$?cr.a1:cr.a8;--t>=o;)if(E(r[t],e))return!1;return!0}function _(r,e){var n="";if(r.flags&ar.KSIDE_CASTLE)n="O-O";else if(r.flags&ar.QSIDE_CASTLE)n="O-O-O";else{var t=w(r,e);r.piece!==F&&(n+=r.piece.toUpperCase()+t),r.flags&(ar.CAPTURE|ar.EP_CAPTURE)&&(r.piece===F&&(n+=Q(r.from)[0]),n+="x"),n+=Q(r.to),r.flags&ar.PROMOTION&&(n+="="+r.promotion.toUpperCase())}return L(r),b()&&(n+=C()?"#":"+"),D(),n}function S(r){return r.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}function d(r,e){for(var n=cr.a8;n<=cr.h1;n++)if(136&n)n+=7;else if(null!=vr[n]&&vr[n].color===r){var t=vr[n],o=n-e,i=o+119;if(tr[i]&1<<ir[t.type]){if(t.type===F){if(o>0){if(t.color===$)return!0}else if(t.color===B)return!0;continue}if("n"===t.type||"k"===t.type)return!0;for(var f=or[i],a=n+f,u=!1;a!==e;){if(null!=vr[a]){u=!0;break}a+=f}if(!u)return!0}}return!1}function A(r){return d(R(r),Er[r])}function b(){return A(hr)}function C(){return b()&&0===v().length}function m(){return!b()&&0===v().length}function T(){for(var r={},e=[],n=0,t=0,o=cr.a8;o<=cr.h1;o++)if(t=(t+1)%2,136&o)o+=7;else{var i=vr[o];i&&(r[i.type]=i.type in r?r[i.type]+1:1,i.type===H&&e.push(t),n++)}if(2===n)return!0;if(3===n&&(1===r[H]||1===r[G]))return!0;if(n===r[H]+2){for(var f=0,a=e.length,o=0;a>o;o++)f+=e[o];if(0===f||f===a)return!0}return!1}function y(){for(var r=[],e={},n=!1;;){var t=D();if(!t)break;r.push(t)}for(;;){var o=f().split(" ").slice(0,4).join(" ");if(e[o]=o in e?e[o]+1:1,e[o]>=3&&(n=!0),!r.length)break;L(r.pop())}return n}function I(r){br.push({move:r,kings:{b:Er.b,w:Er.w},turn:hr,castling:{b:_r.b,w:_r.w},ep_square:Sr,half_moves:dr,move_number:Ar})}function L(r){var e=hr,n=R(e);if(I(r),vr[r.to]=vr[r.from],r.from!=r.to&&(vr[r.from]=null),r.flags&ar.EP_CAPTURE&&(hr===B?vr[r.to-16]=null:vr[r.to+16]=null),r.flags&ar.PROMOTION&&(vr[r.to]={type:r.promotion,color:e}),vr[r.to].type===z){if(Er[vr[r.to].color]=r.to,r.flags&ar.KSIDE_CASTLE){var t=r.to-1,o=r.rook_sq;vr[t]={type:W,color:e},o!==r.to&&o!==t&&(vr[o]=null)}else if(r.flags&ar.QSIDE_CASTLE){var t=r.to+1,o=r.rook_sq;vr[t]={type:W,color:e},o!==r.to&&o!==t&&(vr[o]=null)}_r[e]=""}if(_r[e])for(var i=0,f=gr[e].length;f>i;i++)if(r.from===gr[e][i].square&&_r[e]&gr[e][i].flag){_r[e]^=gr[e][i].flag;break}if(_r[n])for(var i=0,f=gr[n].length;f>i;i++)if(r.to===gr[n][i].square&&_r[n]&gr[n][i].flag){_r[n]^=gr[n][i].flag;break}Sr=r.flags&ar.BIG_PAWN?"b"===hr?r.to-16:r.to+16:j,r.piece===F?dr=0:r.flags&(ar.CAPTURE|ar.EP_CAPTURE)?dr=0:dr++,hr===B&&Ar++,hr=R(hr)}function D(){var r=br.pop();if(null==r)return null;var e=r.move;Er=r.kings,hr=r.turn,_r=r.castling,Sr=r.ep_square,dr=r.half_moves,Ar=r.move_number;var n=hr,t=R(hr);if(e.from!=e.to&&(vr[e.from]=vr[e.to],vr[e.from].type=e.piece,vr[e.to]=null),e.flags&ar.CAPTURE)vr[e.to]={type:e.captured,color:t};else if(e.flags&ar.EP_CAPTURE){var o;o=n===B?e.to-16:e.to+16,vr[o]={type:F,color:t}}if(e.flags&(ar.KSIDE_CASTLE|ar.QSIDE_CASTLE)){var i;e.flags&ar.KSIDE_CASTLE?(castling_to=e.rook_sq,castling_from=e.to-1):e.flags&ar.QSIDE_CASTLE&&(castling_to=e.rook_sq,castling_from=e.to+1),vr[i]={type:W,color:n},vr[castling_to]={type:W,color:n},castling_from!==e.from&&castling_from!==castling_to&&(vr[castling_from]=null)}return e}function w(r,e){for(var n=v({legal:!e}),t=r.from,o=r.to,i=r.piece,f=0,a=0,u=0,l=0,s=n.length;s>l;l++){var p=n[l].from,c=n[l].to,E=n[l].piece;i===E&&t!==p&&o===c&&(f++,K(t)===K(p)&&a++,q(t)===q(p)&&u++)}return f>0?a>0&&u>0?Q(t):Q(t).charAt(u>0?1:0):""}function P(){for(var r="   +------------------------+\n",e=cr.a8;e<=cr.h1;e++){if(0===q(e)&&(r+=" "+"87654321"[K(e)]+" |"),null==vr[e])r+=" . ";else{var n=vr[e].type,t=vr[e].color,o=t===$?n.toUpperCase():n.toLowerCase();r+=" "+o+" "}e+1&136&&(r+="|\n",e+=8)}return r+="   +------------------------+\n",r+="     a  b  c  d  e  f  g  h\n"}function k(r,e){var n=S(r);if(e){var t=n.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/);if(t)var o=t[1],i=t[2],f=t[3],a=t[4]}for(var u=v(),l=0,s=u.length;s>l;l++){if(n===S(_(u[l]))||e&&n===S(_(u[l],!0)))return u[l];if(!(!t||o&&o.toLowerCase()!=u[l].piece||cr[i]!=u[l].from||cr[f]!=u[l].to||a&&a.toLowerCase()!=u[l].promotion))return u[l]}return null}function K(r){return r>>4}function q(r){return 15&r}function Q(r){var e=q(r),n=K(r);return"abcdefgh".substring(e,e+1)+"87654321".substring(n,n+1)}function R(r){return r===$?B:$}function O(r){return-1!=="0123456789".indexOf(r)}function N(r){var e=x(r);e.san=_(e,!1),e.to=Q(e.to),e.from=Q(e.from);var n="";for(var t in ar)ar[t]&e.flags&&(n+=fr[t]);return e.flags=n,e}function x(r){var e=r instanceof Array?[]:{};for(var n in r)"object"==typeof n?e[n]=x(r[n]):e[n]=r[n];return e}function U(r){return r.replace(/^\s+|\s+$/g,"")}function M(r){for(var e=v({legal:!1}),n=0,t=hr,o=0,i=e.length;i>o;o++){if(L(e[o]),!A(t))if(r-1>0){var f=M(r-1);n+=f}else n++;D()}return n}var B="b",$="w",j=-1,F="p",G="n",H="b",W="r",Z="q",z="k",J="pnbrqkPNBRQK",V="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",X=["1-0","0-1","1/2-1/2","*"],Y=1,rr=2,er={b:[16,32,17,15],w:[-16,-32,-17,-15]},nr={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},tr=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],or=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],ir={p:0,n:1,b:2,r:3,q:4,k:5},fr={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},ar={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},ur=7,lr=6,sr=1,pr=0,cr={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},vr=new Array(128),Er={w:j,b:j},gr={w:[],b:[]},hr=$,_r={w:0,b:0},Sr=j,dr=0,Ar=1,br=[],Cr={},mr=e||Y;return o("undefined"==typeof r?V:r),{WHITE:$,BLACK:B,PAWN:F,KNIGHT:G,BISHOP:H,ROOK:W,QUEEN:Z,KING:z,SQUARES:function(){for(var r=[],e=cr.a8;e<=cr.h1;e++)136&e?e+=7:r.push(Q(e));return r}(),FLAGS:fr,load:function(r,e){return o(r,null,e)},reset:function(){return t()},moves:function(r){for(var e=v(r),n=[],t=0,o=e.length;o>t;t++)n.push("undefined"!=typeof r&&"verbose"in r&&r.verbose?N(e[t]):_(e[t],!1));if(mr==rr)for(var t=0,o=n.length;o>t;t++){var i=n[t];(i.flags==fr.KSIDE_CASTLE||i.flags==fr.QSIDE_CASTLE)&&(i.to=Q(i.rook_sq))}return n},in_check:function(){return b()},in_checkmate:function(){return C()},in_stalemate:function(){return m()},in_draw:function(){return dr>=100||m()||T()||y()},insufficient_material:function(){return T()},in_threefold_repetition:function(){return y()},game_over:function(){return dr>=100||C()||m()||T()||y()},validate_fen:function(r){return i(r)},fen:function(){return f()},board:function(){for(var r=[],e=[],n=cr.a8;n<=cr.h1;n++)e.push(null==vr[n]?null:{type:vr[n].type,color:vr[n].color}),n+1&136&&(r.push(e),e=[],n+=8);return r},pgn:function(r){var e="object"==typeof r&&"string"==typeof r.newline_char?r.newline_char:"\n",n="object"==typeof r&&"number"==typeof r.max_width?r.max_width:0,t=[],o=!1;for(var i in Cr)t.push("["+i+' "'+Cr[i]+'"]'+e),o=!0;o&&br.length&&t.push(e);for(var f=[];br.length>0;)f.push(D());for(var a=[],u="";f.length>0;){var l=f.pop();br.length||"b"!==l.color?"w"===l.color&&(u.length&&a.push(u),u=Ar+"."):u=Ar+". ...",u=u+" "+_(l,!1),L(l)}if(u.length&&a.push(u),"undefined"!=typeof Cr.Result&&a.push(Cr.Result),0===n)return t.join("")+a.join(" ");for(var s=0,i=0;i<a.length;i++)s+a[i].length>n&&0!==i?(" "===t[t.length-1]&&t.pop(),t.push(e),s=0):0!==i&&(t.push(" "),s++),t.push(a[i]),s+=a[i].length;return t.join("")},load_pgn:function(r,e){function n(r){return r.replace(/\\/g,"\\")}function i(r){for(var e in r)return!0;return!1}function f(r,e){for(var t="object"==typeof e&&"string"==typeof e.newline_char?e.newline_char:"\r?\n",o={},i=r.split(new RegExp(n(t))),f="",a="",u=0;u<i.length;u++)f=i[u].replace(/^\[([A-Z][A-Za-z]*)\s.*\]$/,"$1"),a=i[u].replace(/^\[[A-Za-z]+\s"(.*)"\]$/,"$1"),U(f).length>0&&(o[f]=a);return o}var u="undefined"!=typeof e&&"sloppy"in e?e.sloppy:!1,l="object"==typeof e&&"string"==typeof e.newline_char?e.newline_char:"\r?\n",s=new RegExp("^(\\[(.|"+n(l)+")*\\])("+n(l)+")*1.("+n(l)+"|.)*$","g"),p=r.replace(s,"$1");"["!==p[0]&&(p=""),t();var c=f(p,e);for(var v in c)a([v,c[v]]),"variant"==v.toLowerCase()&&"chess960"==c[v].toLowerCase()&&(mr=rr);if("FEN"in c&&o(c.FEN),"1"===c.SetUp&&!("FEN"in c&&o(c.FEN,!0)))return!1;var E=r.replace(p,"").replace(new RegExp(n(l),"g")," ");E=E.replace(/(\{[^}]+\})+?/g,"");for(var g=/(\([^\(\)]+\))+?/g;g.test(E);)E=E.replace(g,"");E=E.replace(/\d+\.(\.\.)?/g,""),E=E.replace(/\.\.\./g,""),E=E.replace(/\$\d+/g,"");var h=U(E).split(new RegExp(/\s+/));h=h.join(",").replace(/,,+/g,",").split(",");for(var _="",S=0;S<h.length-1;S++){if(_=k(h[S],u),null==_)return!1;L(_)}if(_=h[h.length-1],X.indexOf(_)>-1)i(Cr)&&"undefined"==typeof Cr.Result&&a(["Result",_]);else{if(_=k(_,u),null==_)return!1;L(_)}return!0},header:function(){return a(arguments)},ascii:function(){return P()},turn:function(){return hr},move:function(r,e){var n="undefined"!=typeof e&&"sloppy"in e?e.sloppy:!1,t=null;if("string"==typeof r)t=k(r,n);else if("object"==typeof r){var o=v();if(mr==rr)for(var i=0,f=o.length;f>i;i++)if((o[i].flags==ar.KSIDE_CASTLE||o[i].flags==ar.QSIDE_CASTLE)&&Q(o[i].rook_sq)==r.to&&r.from==Q(o[i].from)){r={from:Q(o[i].from),to:Q(o[i].to)};break}for(var i=0,f=o.length;f>i;i++)if(!(r.from!==Q(o[i].from)||r.to!==Q(o[i].to)||"promotion"in o[i]&&r.promotion!==o[i].promotion)){t=o[i];break}}if(!t)return null;var a=N(t);return L(t),a},undo:function(){var r=D();return r?N(r):null},clear:function(){return n()},put:function(r,e){return s(r,e)},get:function(r){return l(r)},remove:function(r){return p(r)},perft:function(r){return M(r)},square_color:function(r){if(r in cr){var e=cr[r];return(K(e)+q(e))%2===0?"light":"dark"}return null},history:function(r){for(var e=[],n=[],t=("undefined"!=typeof r&&"verbose"in r&&r.verbose);br.length>0;)e.push(D());for(;e.length>0;){var o=e.pop();n.push(t?N(o):_(o)),L(o)}return n}}};"undefined"!=typeof exports&&(exports.Chess=Chess),"undefined"!=typeof define&&define(function(){return Chess});
